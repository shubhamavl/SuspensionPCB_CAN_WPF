name: Build and Release Portable App

on:
  push:
    tags:
      - 'v*'   # e.g. v1.0.0, v1.1.3

permissions:
  contents: write   # needed to create releases and upload assets

jobs:
  build-and-release:
    runs-on: windows-latest

    env:
      DOTNET_VERSION: '8.0.x'
      # VERSION will be derived from the Git tag name (e.g. v1.2.3 -> 1.2.3)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # fetch full history to check branch

      - name: Verify tag is on master branch
        shell: pwsh
        run: |
          $TAG_NAME = "${{ github.ref_name }}"
          Write-Host "Checking if tag $TAG_NAME is on master branch..."
          
          # Get the commit SHA that the tag points to
          $TAG_COMMIT = git rev-parse "$TAG_NAME`^{commit}"
          
          # Check if this commit is on the master branch
          $branches = git branch -r --contains $TAG_COMMIT
          if ($branches -match "origin/master") {
            Write-Host "✓ Tag $TAG_NAME is on master branch. Proceeding with release."
          } elseif ($branches -match "origin/main") {
            Write-Host "✓ Tag $TAG_NAME is on main branch. Proceeding with release."
          } else {
            Write-Host "❌ ERROR: Tag $TAG_NAME is NOT on master/main branch!"
            Write-Host ""
            Write-Host "Release tags can only be created on the master/main branch."
            Write-Host "This prevents accidental releases from feature branches."
            Write-Host ""
            Write-Host "To fix this:"
            Write-Host "  1. Make sure your changes are merged to master/main"
            Write-Host "  2. Checkout master/main: git checkout master"
            Write-Host "  3. Pull latest: git pull origin master"
            Write-Host "  4. Create tag on master: git tag $TAG_NAME"
            Write-Host "  5. Push tag: git push origin $TAG_NAME"
            Write-Host ""
            Write-Host "Branches containing this tag:"
            git branch -r --contains $TAG_COMMIT
            exit 1
          }

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore SuspensionPCB_CAN_WPF.sln

      - name: Derive version from tag
        id: version
        shell: pwsh
        run: |
          $RAW_TAG = "${{ github.ref_name }}"          # e.g. v1.2.3
          $VERSION = $RAW_TAG -replace '^v', ''        # strip leading 'v' -> 1.2.3
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT

      - name: Publish main WPF application (portable, win-x64)
        run: >
          dotnet publish SuspensionPCB_CAN_WPF.csproj
          -c Release -r win-x64 --self-contained true
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -p:PublishReadyToRun=true
          -p:Version=${{ steps.version.outputs.version }}
          -p:AssemblyVersion=${{ steps.version.outputs.version }}.0
          -p:FileVersion=${{ steps.version.outputs.version }}.0
          -p:InformationalVersion=${{ steps.version.outputs.version }}

      - name: Publish updater helper (portable, win-x64)
        run: >
          dotnet publish SuspensionPCB_Updater/SuspensionPCB_Updater.csproj
          -c Release -r win-x64 --self-contained true
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -p:PublishReadyToRun=true
          -p:Version=${{ steps.version.outputs.version }}
          -p:AssemblyVersion=${{ steps.version.outputs.version }}.0
          -p:FileVersion=${{ steps.version.outputs.version }}.0
          -p:InformationalVersion=${{ steps.version.outputs.version }}

      - name: Copy updater into app publish folder
        shell: pwsh
        run: |
          $APP_PUBLISH = "bin/Release/net8.0-windows/win-x64/publish"
          $UPDATER_PUBLISH = "SuspensionPCB_Updater/bin/Release/net8.0-windows/win-x64/publish"
          Copy-Item "$UPDATER_PUBLISH/SuspensionPCB_Updater.exe" "$APP_PUBLISH/SuspensionPCB_Updater.exe"

      - name: Create portable ZIP package
        shell: pwsh
        run: |
          $APP_PUBLISH = "bin/Release/net8.0-windows/win-x64/publish"
          $ZIP_NAME = "SuspensionPCB_CAN_WPF_Portable_${{ github.ref_name }}.zip"
          Compress-Archive -Path "$APP_PUBLISH/*" -DestinationPath $ZIP_NAME -Force

      - name: Generate SHA-256 hash for security verification
        id: hash
        shell: pwsh
        run: |
          $ZIP_NAME = "SuspensionPCB_CAN_WPF_Portable_${{ github.ref_name }}.zip"
          $SHA256 = (Get-FileHash -Path $ZIP_NAME -Algorithm SHA256).Hash.ToLower()
          echo "hash=$SHA256" >> $env:GITHUB_OUTPUT
          Write-Host "SHA-256: $SHA256"
          # Also save to file for release notes
          $SHA256 | Out-File -FilePath "${ZIP_NAME}.sha256" -NoNewline -Encoding utf8
          Write-Host "Hash saved to ${ZIP_NAME}.sha256"

      - name: Create GitHub Release and upload assets (ZIP + SHA-256)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body: |
            ## Security Verification
            
            **SHA-256 Hash:** `${{ steps.hash.outputs.hash }}`
            
            To verify the download integrity, compare the SHA-256 hash of your downloaded file with the hash above.
            
            **Verification command (Windows PowerShell):**
            ```powershell
            Get-FileHash -Path "SuspensionPCB_CAN_WPF_Portable_${{ github.ref_name }}.zip" -Algorithm SHA256
            ```
            
            **Verification command (Linux/Mac):**
            ```bash
            sha256sum SuspensionPCB_CAN_WPF_Portable_${{ github.ref_name }}.zip
            ```
          files: |
            SuspensionPCB_CAN_WPF_Portable_${{ github.ref_name }}.zip
            SuspensionPCB_CAN_WPF_Portable_${{ github.ref_name }}.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

